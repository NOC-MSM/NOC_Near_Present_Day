#!/bin/bash -l
#SBATCH --job-name=NPD_025
#SBATCH --output=./job.out
#SBATCH --error=./job.err
#SBATCH --partition=compute
#SBATCH --time=02:20:00
#SBATCH --partition=compute
#SBATCH --nodes=6
#SBATCH --ntasks=96
#SBATCH --ntasks-per-core=1
#SBATCH --exclusive
#SBATCH hetjob
#SBATCH --partition=compute
#SBATCH --nodes=23
#SBATCH --ntasks=1288
#SBATCH --ntasks-per-core=1
#SBATCH --exclusive
#SBATCH hetjob
#SBATCH --partition=compute
#SBATCH --nodes=1
#SBATCH --ntasks=38
#SBATCH --ntasks-per-core=1
#SBATCH --exclusive
set -u
set -e
set -o pipefail

module load NEMO/prg-env
unset I_MPI_PMI_LIBRARY 

export NEMO_EXP_DIR="/dssgfs01/scratch/acc/NPD/NOC_Near_Present_Day/nemo/cfgs/GLOBAL_QCO/eORCA025"
export XIO_HOME="/home/acc/xios3-trunk-head"
export OMP_NUM_THREADS="1"
export I_MPI_SHM="off"
export XIOS_PROCESSES="96"
export NEMO_PROCESSES="1326"

cd "$NEMO_EXP_DIR"

# Link nemo
echo ln -fs "$NEMO_EXP_DIR"/../BLD/bin/nemo.exe nemo
ln -fs "$NEMO_EXP_DIR"/../BLD/bin/nemo.exe nemo
cp -p "$XIO_HOME"/bin/xios_server.exe xios_server.exe

# Run NEMO
# Placement map generated by: ~acc/mkslurm_nomix_het -S 96 -s 4 -m 16 -C 1326 -g 8 -N 64 -t 02:20:00 -a n01 -j NPD_025

export I_MPI_SHM=off
export I_MPI_PIN_RESPECT_CPUSET=0
export I_MPI_PMI_LIBRARY=/opt/software/slurm/21.08.5/lib/libpmi2.so

cat > myscript_wrapper.sh << EOFB
#!/bin/ksh
#
set -A map ./xios_server.exe ./nemo
exec_map=( 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 )
#
exec \${map[\${exec_map[\$SLURM_PROCID]}]}
##
EOFB
chmod u+x ./myscript_wrapper.sh

srun --mem=99G --mem-bind=local --mpi=pmi2 --hint=nomultithread \
--het-group=0 --nodes=6 --ntasks=96 --ntasks-per-node=16 --cpu-bind=v,mask_cpu:0x1,0x10,0x100,0x1000,0x10000,0x100000,0x1000000,0x10000000,0x100000000,0x1000000000,0x10000000000,0x100000000000,0x1000000000000,0x10000000000000,0x100000000000000,0x1000000000000000 ./myscript_wrapper.sh \
: --het-group=1 --nodes=23 --ntasks=1288 --ntasks-per-node=56 --cpu-bind=v,mask_cpu:0x1,0x2,0x4,0x8,0x10,0x20,0x40,0x100,0x200,0x400,0x800,0x1000,0x2000,0x4000,0x10000,0x20000,0x40000,0x80000,0x100000,0x200000,0x400000,0x1000000,0x2000000,0x4000000,0x8000000,0x10000000,0x20000000,0x40000000,0x100000000,0x200000000,0x400000000,0x800000000,0x1000000000,0x2000000000,0x4000000000,0x10000000000,0x20000000000,0x40000000000,0x80000000000,0x100000000000,0x200000000000,0x400000000000,0x1000000000000,0x2000000000000,0x4000000000000,0x8000000000000,0x10000000000000,0x20000000000000,0x40000000000000,0x100000000000000,0x200000000000000,0x400000000000000,0x800000000000000,0x1000000000000000,0x2000000000000000,0x4000000000000000 ./myscript_wrapper.sh \
: --het-group=2 --nodes=1 --ntasks=38 --ntasks-per-node=38 --cpu-bind=v,mask_cpu:0x1,0x2,0x4,0x8,0x10,0x20,0x40,0x100,0x200,0x400,0x800,0x1000,0x2000,0x4000,0x10000,0x20000,0x40000,0x80000,0x100000,0x200000,0x400000,0x1000000,0x2000000,0x4000000,0x8000000,0x10000000,0x20000000,0x40000000,0x100000000,0x200000000,0x400000000,0x800000000,0x1000000000,0x2000000000,0x4000000000,0x10000000000,0x20000000000,0x40000000000 ./myscript_wrapper.sh &

wait

# Move log files
mkdir -p LOGS/"$SLURM_JOB_ID"
mv {*.dat,*output*,*.stat*,communication_report.txt} LOGS/"$SLURM_JOB_ID"

# Check time.step and ocean.output
for NAMELIST in *namelist_cfg; do

    # Check that ocean.output exist
    OUTNAME=${NAMELIST//namelist_cfg/ocean.output}
    OUTNAME=LOGS/"$SLURM_JOB_ID"/"$OUTNAME"
    if [ ! -f  "$OUTNAME" ]; then
        echo "E R R O R : $OUTNAME is missing."
        exit 1
    fi

    # Check for errors
    ERROR=$(grep "E R R O R" "$OUTNAME" | wc -l)
    if [ "$ERROR" -gt 0 ]; then
        echo "E R R O R : errors found in $OUTNAME"
        exit 1
    fi

    # Check that time.step exist
    TIMENAME=${NAMELIST//namelist_cfg/time.step}
    if [ ! -f  "$TIMENAME" ]; then
        echo "E R R O R : $TIMENAME is missing."
        exit 1
    fi

    # Check nn_itend vs time.step
    EXPECTED=$(get_var nn_itend "$NAMELIST")
    ACTUAL=$(get_timestep "$TIMENAME")
    if [ "$ACTUAL" -lt "$EXPECTED" ]; then
        echo "E R R O R : $TIMENAME is $ACTUAL (expecting $EXPECTED)"
        exit 1
    fi
done
