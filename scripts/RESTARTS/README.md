# NOC NPD: Post-Processing Ocean & Ice Restart Files.

This is a brief guide on rebuilding ocean & ice restart files generated by the NPD eORCA1, eORCA025 and eORCA12 simulations, and transferring these to JASMIN cloud object storage.

Each NPD simulation produces annual restart files at the end of December of each simulation year. Given that each processor writes its own portion of a restart file to a separate output file, we must first rebuild these into a single output file per restart, before then transferring a subset of these files to the JASMIN cloud object store.

## Quick start on {Archer2|Anemone}

The following commands will check out and set up an instance of NPD. It is not advised to do this in your home directory.

```shell
git clone git@github.com:NOC-MSM/NOC_Near_Present_Day.git
cd NOC_Near_Present_Day
./setup {-s Archer2}
```

## Compiling NEMO REBUILD Tool

To rebuild ocean / ice restart files, we must first compile the `REBUILD_NEMO` tool available in NEMO.

Note you expected to have already compiled NEMO as outlined above & be located in the `NOC_Near_Present_Day` directory.

```shell
cd nemo/tools/

ln -s ../../scripts/compile_tools .

./compile_tools
```

Above we create a symbolic link to the `compile_tools` script and run this to compile the `DOMAIN_cfg`, `REBUILD_NEMO` & `WEIGHTS` tools provided with NEMO.

## Rebuilding Ocean & Ice Restart Files

Now we have compiled the `REBUILD_NEMO` tool, we can run each of the `rebuild_eORCA???_ocean_restart.sh` and `rebuild_eORCA???_ice_restart.sh` scripts to rebuild all of the available restart files located in the `RESTART/` directory inside your model run directory.

Note: for eORCA1 & eORCA025 scripts write the rebuilt restart files to the `/dssgfs01/scratch/npd/restarts/eORCA1_ERA5_v1/` and `/dssgfs01/scratch/npd/restarts/eORCA025_ERA5_v1/` shared NPD directories on Anemone by default.

Users should modify the following path definitions under -- Inputs -- prior to running the script:

```shell
# -- Inputs -- #
# Define path to NEMO directory in NOC_Near_Present_Day:
nemo_dir=..../NOC_Near_Present_Day/nemo
# Define restart directory and collect unique restart files:
restart_dir=$nemo_dir/cfgs/GLOBAL_QCO/eORCA1/RESTARTS/
# Define output directory for rebuilt restart files:
output_dir=/dssgfs01/scratch/npd/restarts/eORCA1_ERA5_v1/
```

Then, we can either use `screen`, `tmux` or `SLURM` to run the script (this is necessary as it can take a while to rebuild a large number of restart files). For example:

```shell
./rebuild_eORCA1_ocean_restarts.sh
```

## Transferring Restart Files to the JASMIN Object Store

Once you have rebuilt all annual ocean & ice restart files, we next need to transfer a subset of these to the JASMIN cloud object store in their original archival (NETCDF4) format to be made publicly available for other users.

We have provided scripts to do this for each of the NPD eORCA1, eORCA025 & eORCA12 simulations. For example, to transfer annual restart files for eORCA025, we can run:

```shell
./send_eORCA025_restarts_to_jasmin_os.sh
```

As above, the paths included in these scripts point to the NPD shared directory on Anemone by default. Users should hence modify the following paths under -- Inputs -- prior to running each script.

```shell
# -- Inputs -- #
# Define restart directory and collect unique restart files:
restart_dir=/dssgfs01/scratch/npd/restarts/eORCA1_ERA5_v1/jasmin_os/
# Define destination path in JASMIN object store:
dest=jasmin-os/npd-eorca1-era5v1/restarts
```
**Note:**
The scripts above use the MinIO client to `PUT` restart NETCDF files into the JASMIN object store and require the user to have permissions to write data to the `noc-msm` tenancy.

To download & set-up the MinIO client visit: https://help.jasmin.ac.uk/docs/short-term-project-storage/using-the-jasmin-object-store/#using-the-minio-client

To request write access to the `noc-msm` tenancy, contact Ollie Tooth (oliver.tooth@noc.ac.uk) or Adam Blaker (atb299@noc.ac.uk).
